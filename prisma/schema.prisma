datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  TEACHER
}

enum InquestType {
  ABSENT
  NEGLIGENCE
}

enum InquestStatus {
  PENDING
  RESPONDED
  COMPLETED
}

model User {
id        String   @id @default(cuid())
email     String   @unique
username  String   @unique
name      String
password  String
role      Role
createdAt DateTime @default(now())
updatedAt DateTime @updatedAt
// Relations
inquestsCreated  Inquest[] @relation("InquestsCreated")
inquestsReceived Inquest[] @relation("InquestsReceived")
notifications    Notification[]
teacherProfile   Teacher?
// Many-to-many: Teachers teach multiple classes
classes          ClassOnTeacher[]
// Many-to-many: Teachers teach multiple subjects
subjects         SubjectOnTeacher[]
passwordResetTokens PasswordResetToken[]

announcements Announcement[] @relation("AnnouncementsCreated")

announcementRecipients AnnouncementRecipient[]
}

model Teacher {
  id         String   @id @default(cuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String   @unique

  jobTitle   String?
  specialty  String?
  schoolName String?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt  // ← This fixes it
}
model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String
  expires   DateTime
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
model Class {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  teachers  ClassOnTeacher[]
}

model Subject {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  teachers  SubjectOnTeacher[]
}

// Junction table: Teacher ↔ Class (many-to-many)
model ClassOnTeacher {
  teacherId String
  classId   String

  teacher   User   @relation(fields: [teacherId], references: [id])
  class     Class  @relation(fields: [classId], references: [id])

  @@id([teacherId, classId])
}

// Junction table: Teacher ↔ Subject (many-to-many)
model SubjectOnTeacher {
  teacherId String
  subjectId String

  teacher   User     @relation(fields: [teacherId], references: [id])
  subject   Subject  @relation(fields: [subjectId], references: [id])

  @@id([teacherId, subjectId])
}

model Inquest {
  id                   String         @id @default(cuid())
  inquestType          InquestType
  reason               String
  details              String?
  date                 DateTime       @default(now())
  teacherClarification String?
  attachmentUrl        String?
  status               InquestStatus  @default(PENDING)

  teacherJobTitle      String?
  teacherSpecialty     String?
  teacherSchool        String?
  clarificationRequest String?
  principalOpinion     String?
  decisionText         String?

  academicYear         AcademicYear   @relation(fields: [academicYearId], references: [id])
  academicYearId       String

  createdBy            User           @relation("InquestsCreated", fields: [createdById], references: [id])
  createdById          String

  teacher              User           @relation("InquestsReceived", fields: [teacherId], references: [id])
  teacherId            String

  notifications        Notification[]

  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
}

model Notification {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  title     String
  body      String
  link      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  inquest   Inquest? @relation(fields: [inquestId], references: [id])
  inquestId String?
}

model AcademicYear {
  id        String   @id @default(cuid())
  name      String   @unique
  startDate DateTime
  endDate   DateTime
  isCurrent Boolean  @default(false)

  inquests  Inquest[]
}
model Announcement {
  id          String   @id @default(cuid())
  title       String
  body        String
  attachmentUrl String? // optional file (PDF, image, etc.)
  date        DateTime // the date the announcement is for / published on
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Who created it (always an admin)
  createdBy   User     @relation("AnnouncementsCreated", fields: [createdById], references: [id])
  createdById String

  // Targeting
  type        AnnouncementType @default(GENERAL) // GENERAL or TARGETED

  // Relations
  recipients  AnnouncementRecipient[] // many-to-many with read status
}

enum AnnouncementType {
  GENERAL   // visible to ALL teachers
  TARGETED  // visible only to selected teachers/subjects
}

model AnnouncementRecipient {
  id               String   @id @default(cuid())
  announcement     Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  announcementId   String
  teacher          User     @relation(fields: [teacherId], references: [id])
  teacherId        String
  read             Boolean  @default(false)
  readAt           DateTime?

  @@unique([announcementId, teacherId])
}